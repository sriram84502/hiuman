<VirtualHost *:80>
    DocumentRoot /var/www/html
    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    
    # Proxy WebSocket to Node.js
    ProxyPreserveHost On
    
    RewriteEngine On
    
    # 1. Handle WebSocket Upgrade (wss:// -> ws://)
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/socket.io/(.*) ws://localhost:3001/socket.io/$1 [P,L]

    # 2. Handle Standard HTTP Polling
    ProxyPass /socket.io http://localhost:3001/socket.io
    ProxyPassReverse /socket.io http://localhost:3001/socket.io
    
    # 3. Exclude /api request from SPA rewrite (let api/.htaccess handle them)
    RewriteCond %{REQUEST_URI} ^/api
    RewriteRule ^ - [L]

    # 4. Exclude /assets from SPA rewrite (Serve statically or 404)
    RewriteCond %{REQUEST_URI} ^/assets
    RewriteRule ^ - [L]

    # 5. SPA Fallback: If not file/dir, go to index.html
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^ /index.html [L]
</VirtualHost>
